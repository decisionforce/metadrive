"""
This test script makes sure that the detection result is the same as the visualization results.
"""
from metadrive.envs.metadrive_env import MetaDriveEnv
import numpy as np

pg_gt_1 = [
0.13,
0.11,
0.1,
0.1,
0.1,
0.09,
0.1,
0.1,
0.1,
0.11,
0.12,
0.13,
0.16,
0.21,
1.0,
0.89,
0.64,
0.51,
0.41,
0.33,
0.27,
0.23,
0.19,
0.17,
0.15,
0.14,
0.13,
0.12,
0.12,
0.12,
0.11,
0.11,
0.12,
0.12,
0.12,
0.13,
0.14,
0.16,
0.18,
0.21,
0.24,
0.29,
0.36,
0.44,
0.55,
0.68,
0.85,
0.28,
0.18,
0.15,
0.5,
0.01,
0.5,
0.5,
0.5,
0.0,
0.13,
0.03,
0.03,
0.03,
0.02,
0.02,
0.02,
0.02,
0.03,
0.03,
0.03,
0.03,
0.16,
0.21,
1.0,
0.08,
0.48,
0.35,
0.41,
0.33,
0.13,
0.23,
0.19,
0.07,
0.06,
0.06,
0.13,
0.12,
0.12,
0.12,
0.11,
0.11,
0.05,
0.05,
0.05,
0.05,
0.06,
0.06,
0.18,
0.21,
0.11,
0.29,
0.2,
0.44,
0.39,
0.13,
0.07,
0.28,
0.18,
0.15,
0.0,
0.43,
0.0,
0.5,
0.5,
0.27,
0.42,
0.0,
0.5,
0.5,
1.0,
1.0,
1.0,
1.0,
1.0,
1.0,
1.0,
1.0,
1.0,
1.0,
]

pg_gt_2 = [
    0.10000000149011612,
    0.10999999940395355,
    0.10999999940395355,
    0.10999999940395355,
    0.11999999731779099,
    0.12999999523162842,
    0.14000000059604645,
    0.1599999964237213,
    0.1899999976158142,
    0.23999999463558197,
    0.3400000035762787,
    0.5600000023841858,
    1.0,
    1.0,
    0.5600000023841858,
    0.3400000035762787,
    0.23999999463558197,
    0.1899999976158142,
    0.1599999964237213,
    0.14000000059604645,
    0.12999999523162842,
    0.11999999731779099,
    0.10999999940395355,
    0.10999999940395355,
    0.10999999940395355,
    0.10000000149011612,
    0.10999999940395355,
    0.10999999940395355,
    0.10999999940395355,
    0.11999999731779099,
    0.12999999523162842,
    0.14000000059604645,
    0.1599999964237213,
    0.1899999976158142,
    0.23999999463558197,
    0.3400000035762787,
    0.5199999809265137,
    0.7099999785423279,
    0.8999999761581421,
    1.0,
    0.3400000035762787,
    0.23999999463558197,
    0.1899999976158142,
    0.1599999964237213,
    0.14000000059604645,
    0.12999999523162842,
    0.11999999731779099,
    0.10999999940395355,
    0.10999999940395355,
    0.10999999940395355,
    0.5,
    0.009999999776482582,
    0.5,
    0.5,
    0.5,
    0.0,
    0.029999999329447746,
    0.10999999940395355,
    0.10999999940395355,
    0.10999999940395355,
    0.11999999731779099,
    0.12999999523162842,
    0.14000000059604645,
    0.05000000074505806,
    0.05999999865889549,
    0.07999999821186066,
    0.3400000035762787,
    0.5600000023841858,
    0.5600000023841858,
    0.5600000023841858,
    0.5600000023841858,
    0.3400000035762787,
    0.07999999821186066,
    0.05999999865889549,
    0.05000000074505806,
    0.14000000059604645,
    0.12999999523162842,
    0.11999999731779099,
    0.10999999940395355,
    0.10999999940395355,
    0.10999999940395355,
    0.029999999329447746,
    0.029999999329447746,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.05000000074505806,
    0.1599999964237213,
    0.1899999976158142,
    0.23999999463558197,
    0.10999999940395355,
    0.18000000715255737,
    0.47999998927116394,
    0.8999999761581421,
    0.18000000715255737,
    0.10999999940395355,
    0.23999999463558197,
    0.1899999976158142,
    0.1599999964237213,
    0.05000000074505806,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.029999999329447746,
    0.30000001192092896,
    0.5,
    0.0,
    0.5,
    0.5,
    0.699999988079071,
    0.5,
    0.0,
    0.5,
    0.5,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
]


def test_pg_map():
    env = MetaDriveEnv({"use_render": True,
                        "debug_static_world": True,
                        "debug": True,
                        "num_scenarios": 1,
                        "traffic_density": 0,
                        "start_seed": 74,
                        "map": 1,
                        "vehicle_config": {
                            "lidar": dict(num_lasers=10, distance=50),
                            "side_detector": dict(num_lasers=50, distance=50),
                            "lane_line_detector": dict(num_lasers=50, distance=50),
                        },
                        })
    try:
        env.reset()
        env.vehicle.set_position([73, 12])
        for s in range(1, 5):
            o, r, tm, tc, info = env.step([0, 0])

        print("[")
        for _o in o.tolist():
            print("{},".format(_o))
        print("]")
        np.testing.assert_almost_equal(pg_gt_1, np.round(o, 2), decimal=2)

        env.vehicle.set_position([30, 3.5])
        for s in range(1, 5):
            o, r, tm, tc, info = env.step([0, 0])
        print("[")
        for _o in o:
            print("{},".format(round(_o, 2)))
        print("]")
        np.testing.assert_almost_equal(np.array(pg_gt_2), o, decimal=2)
    finally:
        env.close()


if __name__ == '__main__':
    test_pg_map()